#!/usr/bin/env python3
"""
MX-PENTEST - Subdomain Scanner
Hecho en MÃ©xico ðŸ‡²ðŸ‡½ - Escanea subdominios como dios manda
"""

import requests
import threading
import queue
import dns.resolver
import argparse
from colorama import init, Fore, Style

init(autoreset=True)

class SubdomainScanner:
    def __init__(self, dominio, wordlist=None, threads=20):
        self.dominio = dominio
        self.threads = threads
        self.encontrados = []
        self.queue = queue.Queue()
        
        # Wordlist por defecto
        if wordlist:
            with open(wordlist, 'r') as f:
                self.subdominios = [line.strip() for line in f]
        else:
            self.subdominios = ['www', 'mail', 'ftp', 'localhost', 'webmail', 'smtp', 
                               'pop', 'ns1', 'webdisk', 'ns2', 'cpanel', 'whm', 
                               'autodiscover', 'autoconfig', 'm', 'imap', 'test', 
                               'ns', 'blog', 'pop3', 'dev', 'www2', 'admin', 'forum',
                               'news', 'vpn', 'ns3', 'mail2', 'new', 'mysql', 'old',
                               'lists', 'support', 'mobile', 'mx', 'static', 'docs',
                               'beta', 'shop', 'sql', 'secure', 'demo', 'cp', 'calendar']
    
    def check_subdomain(self, subdomain):
        """Verifica si un subdominio existe"""
        try:
            # Probar resoluciÃ³n DNS
            full_domain = f"{subdomain}.{self.dominio}"
            
            # A records
            answers = dns.resolver.resolve(full_domain, 'A')
            if answers:
                ip = answers[0].to_text()
                self.encontrados.append({
                    'subdominio': full_domain,
                    'ip': ip,
                    'tipo': 'A'
                })
                print(f"{Fore.GREEN}[+] {full_domain} -> {ip}{Style.RESET_ALL}")
                
        except dns.resolver.NXDOMAIN:
            pass
        except dns.resolver.NoAnswer:
            pass
        except dns.resolver.Timeout:
            pass
        except Exception as e:
            pass
    
    def worker(self):
        """Worker para threading"""
        while True:
            try:
                subdomain = self.queue.get(timeout=5)
                self.check_subdomain(subdomain)
            except queue.Empty:
                break
            except Exception as e:
                continue
            finally:
                self.queue.task_done()
    
    def scan(self):
        """Ejecuta el escaneo"""
        print(f"{Fore.CYAN}[+] Escaneando subdominios de {self.dominio}{Style.RESET_ALL}")
        print(f"{Fore.CYAN}[+] Usando {self.threads} hilos{Style.RESET_ALL}")
        
        # Llenar cola
        for sub in self.subdominios:
            self.queue.put(sub)
        
        # Iniciar workers
        threads = []
        for _ in range(min(self.threads, self.queue.qsize())):
            t = threading.Thread(target=self.worker)
            t.start()
            threads.append(t)
        
        # Esperar
        self.queue.join()
        
        for t in threads:
            t.join()
        
        # Mostrar resumen
        print(f"\n{Fore.GREEN}[âœ”] Escaneo completado{Style.RESET_ALL}")
        print(f"{Fore.GREEN}[âœ”] Subdominios encontrados: {len(self.encontrados)}{Style.RESET_ALL}")
        
        return self.encontrados

def main():
    parser = argparse.ArgumentParser(description='MX-PENTEST - Subdomain Scanner')
    parser.add_argument('--dominio', '-d', required=True, help='Dominio a escanear')
    parser.add_argument('--wordlist', '-w', help='Wordlist personalizada')
    parser.add_argument('--threads', '-t', type=int, default=20, help='NÃºmero de hilos')
    
    args = parser.parse_args()
    
    scanner = SubdomainScanner(args.dominio, args.wordlist, args.threads)
    resultados = scanner.scan()
    
    # Guardar resultados
    with open(f'subdominios_{args.dominio}.txt', 'w') as f:
        for r in resultados:
            f.write(f"{r['subdominio']} - {r['ip']}\n")
    
    print(f"{Fore.GREEN}[âœ”] Resultados guardados en subdominios_{args.dominio}.txt{Style.RESET_ALL}")

if __name__ == "__main__":
    main()
